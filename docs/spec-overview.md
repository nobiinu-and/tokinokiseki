# EasyAlbum 機能概要

写真をたくさん撮るが整理が苦手なユーザーのための、「見返す楽しさ」を軸にしたデスクトップアルバムアプリ。
膨大な写真の中から気になるイベント（日）を開いてベストショットを選び、スライドショーで楽しめる。
AI（CLIP / YOLO）による自動タグ付け・回転補正・重複検出も搭載。

## 技術スタック

| レイヤー | 技術 |
|---|---|
| フレームワーク | Electron + React + TypeScript |
| ビルド | electron-vite, electron-builder (NSIS) |
| データベース | sql.js（WASM SQLite、インメモリ + 手動ディスク保存） |
| EXIF解析 | exifr |
| サムネイル | Electron nativeImage（長辺300px, JPEG品質80） |
| HEIC変換 | heic-convert（Worker Thread） |
| AI推論 | Transformers.js（CLIP, YOLO — Worker Thread） |
| 仮想スクロール | react-virtuoso |
| ルーティング | react-router-dom（HashRouter） |

## 画面構成

```
フォルダ選択 (/)
  ↓
イベント一覧 (/events)  ──→  タグ検索 (/tags)
  ↓
イベント詳細 (/events/:date)
  ├──→ Lightbox（写真拡大表示）
  ├──→ 自動タグ付けダイアログ
  ├──→ 重複チェックダイアログ
  └──→ スライドショー (/slideshow/:date)

スライドショー (/slideshow) ← 全日付のベスト写真
```

---

## 1. フォルダスキャン

写真フォルダを指定すると、再帰的にファイルを検出し、メタデータを読み取ってDBに登録する。

- **対応フォーマット**: `.jpg`, `.jpeg`, `.png`, `.heic`, `.heif`, `.webp`
- **メタデータ**: EXIF DateTimeOriginal → `taken_at`。EXIF がなければファイル更新日時にフォールバック
- **サムネイル生成**: スキャン時に長辺300px の JPEG をキャッシュ（`userData/thumbnails/{MD5}.jpg`）
- **重複スキップ**: 既存パスはスキップ、サムネイル欠損時は再生成
- **進捗表示**: ファイル検出フェーズ → 処理フェーズのカウンタ + プログレスバー
- **バッチ保存**: 100件ごとに DB をディスク保存

## 2. イベント一覧

写真を日付でグルーピングし、カレンダー風に一覧表示する。

- **イベント判定**: 3枚以上の日は「イベント」として大きいカード表示、1〜2枚はコンパクト表示
- **年月セクション**: 「2024年8月」のようなヘッダーでグループ化
- **旅行検出**: 2日以内の間隔で連続するイベント日を「旅行」として視覚的にグループ化（サイドバー/背景色）
- **ジャンプバー**: 年を選択してスクロール位置を即座に移動
- **仮想スクロール**: GroupedVirtuoso で数千イベントも快適に描画

## 3. イベント詳細（写真グリッド）

特定の日付の写真をグリッド表示する。

- **仮想グリッド**: VirtuosoGrid による高速描画
- **サムネイル表示**: ベストマーク（★）、タグバッジ、回転補正を反映
- **操作**: 写真クリックで Lightbox 起動
- **ツールバー**: タグ付け / 重複チェック / スライドショーボタン

## 4. Lightbox（写真拡大表示）

写真をフルスクリーンで表示するビューア。

- **ナビゲーション**: 左右矢印キー / ボタンで前後移動
- **ベストマーク**: ★ ボタンでトグル
- **回転補正**: `orientationCorrection` に基づく CSS transform
- **タグ編集**: フッターにインラインタグエディタ
  - 既存タグ: 色付きチップ + × ボタンで削除
  - 新規タグ: テキスト入力 + 候補ドロップダウン（既存タグからフィルタ）
  - キーボード: 上下キーで候補選択、Enter で追加、Escape でクリア
- **キーボード**: Escape で閉じる（タグ入力中は Lightbox キーバインド無効）

## 5. ベストマーク & スライドショー

気に入った写真に ★ をつけ、ベスト写真だけをスライドショーで楽しむ。

- **ベストマーク**: Lightbox またはサムネイル上でワンクリックトグル
- **スライドショー**:
  - 対象: ベストマーク付き写真のみ
  - 表示間隔: 5秒（自動切り替え）
  - 操作: クリックで一時停止/再開、左右で手動送り、Escape で終了
  - スコープ: 全日付 or 特定日付

## 6. 自動タグ付け（AI パイプライン）

3フェーズの AI パイプラインで写真に自動タグを付与する。全フェーズは Worker Thread で実行され、UI をブロックしない。

### Phase 0: 回転補正（CLIP）

EXIF に方向情報がない写真の向きを自動検出・補正する。

- 写真を4方向（0°/90°/180°/270°）に回転し、CLIP で「正しい向きの写真」スコアを算出
- 最高スコアの回転角度を `photos.orientation_correction` に保存
- サムネイルを補正済みで再生成
- 閾値: 0.4〜0.9（デフォルト 0.6）

### Phase 1: 物体検出（YOLO）

写真内の物体を検出し、タグとして付与する。

- モデル: Transformers.js による YOLO 系軽量モデル
- COCO 80カテゴリを日本語ラベルにマッピング（人物, 犬, 猫, 車, 椅子, テーブル 等）
- 初回はモデルダウンロード（`userData/detect-models/` にキャッシュ）
- 閾値: 0.3〜0.9（デフォルト 0.5）

### Phase 2: シーン分類（CLIP）

写真の雰囲気・シーンを分類してタグ付けする。

- モデル: CLIP ViT-base-patch32（ゼロショット分類）
- プリセットラベル: 屋外, 屋内, パーティー, 夜景, 夕焼け, 風景, 食事, 旅行 等
- カスタムラベル追加可能（英語ラベル + 日本語表示名）
- 初回はモデルダウンロード（`userData/clip-models/` にキャッシュ、約5分）
- 閾値: 0.3〜0.8（デフォルト 0.5）

### パイプライン共通

- キャンセル: AbortController で任意のフェーズで中断可能
- スコープ: フォルダ全体 or 特定日付
- 進捗: 5枚ごとに UI 更新（フェーズ名 + カウンタ + プログレスバー）

## 7. タグ検索

タグで写真を横断検索する画面。

- **タグチップ一覧**: 全タグを件数付きで表示、クリックで選択/解除
- **写真グリッド**: 選択タグの写真を日付グループ別に表示
- **Lightbox 連携**: タグ編集（追加・削除）が可能
- **リアルタイム更新**: タグ変更時にチップ一覧と写真リストを再取得

## 8. 重複検出

同一日付内の類似写真を検出し、整理を支援する。

- **アルゴリズム**: Difference Hash (dHash) + ハミング距離クラスタリング
  - サムネイルを 9×8px に縮小 → グレースケール差分ハッシュ（64bit）
  - ハミング距離 ≤ 閾値（デフォルト10）の写真を Union-Find でグループ化
- **UI**: グループごとにサムネイル表示 → 削除対象を選択 → ゴミ箱に移動
- **スコープ**: 特定日付のみ（EventDetail から起動）

## 9. HEIC/HEIF 対応

ブラウザが直接表示できない HEIC 形式を透過的にサポートする。

- **変換**: Worker Thread で HEIC → JPEG（品質0.85）に変換
- **キャッシュ**: `userData/heic-cache/{hash}.jpg` に保存
- **表示**: サムネイルもフルサイズも変換済み JPEG 経由
- **回転**: heic-convert が HEIF の irot を適用するため、出力 JPEG は正しいピクセル方向

---

## データベーススキーマ

```sql
folders (id, path, last_scanned_at)
photos  (id, folder_id, file_path, file_name, taken_at, file_modified_at,
         width, height, is_best, orientation_correction, created_at)
tags    (id, name)
photo_tags (id, photo_id, tag_id, confidence)
```

- `photo_tags.confidence`: 自動タグはモデルのスコア、手動タグは 1.0
- `UNIQUE(photo_id, tag_id)`: 同じタグの重複登録を防止
- インデックス: `taken_at`, `is_best`, `folder_id`, `photo_id`, `tag_id`

## 関連ドキュメント

- [MVP仕様書](spec_mvp.md) — 初期設計
- [タグ付け仕様書](spec-tagging.md) — タグシステム詳細設計
- [回転補正仕様書](spec-rotation.md) — 回転検出アルゴリズム
- [sql.js の落とし穴](pitfalls-sql-js.md) — データ永続化の注意点
