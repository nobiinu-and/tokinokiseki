# 旅行検出 仕様書（改訂版）

## 概要

イベント一覧で連続する日付を「旅行」としてグルーピングする機能。
軽い自動サジェストで候補を提示し、ユーザーが確認・手動指定して確定する。
確定した旅行グループは DB に保存され、旅行アルバム作成の起点になる。

### 設計方針

- **ユーザー主導**: 旅行かどうかを決めるのはユーザー。自動検出はあくまでサジェスト
- **シンプル**: 閾値設定画面は設けない。サジェストの精度より、手動操作の手軽さを重視
- **既存UIを壊さない**: イベントカードはそのまま、グルーピングの枠を足すだけ

---

## 旅行グループの状態

| 状態 | 意味 | 表示 |
|---|---|---|
| **サジェスト** | 自動検出した候補。まだユーザーが確認していない | 点線の枠 + 「旅行ですか？」バッジ |
| **確定済み** | ユーザーが確定した旅行グループ | 実線の枠 + 旅行ヘッダー |

---

## 自動サジェスト

### ロジック

固定パラメータで軽く検出する。ユーザー向け設定は不要。

```
パラメータ（固定）:
  minDays = 2      // 2日以上
  maxGap  = 1      // 1日の空白は許容
  minPhotosPerDay = 3  // 1〜2枚の日は日常として除外

入力: イベント日リスト（写真枚数付き）

1. 写真枚数 < minPhotosPerDay の日を除外
2. 残った日を昇順ソート
3. 隣接する日の間隔が maxGap 以下なら連結
4. 連結グループの暦日数（endDate - startDate + 1）が minDays 未満なら除外
5. 既に確定済みの旅行グループと重複するサジェストは除外

出力: サジェスト候補リスト
```

- パラメータは固定値。ユーザーに見せない
- 完璧な検出は目指さない。漏れは手動で作ればよい
- 多少の誤検出は許容。確認ステップがあるので問題にならない

### 計算タイミング

| タイミング | 処理 |
|---|---|
| フォルダスキャン完了時 | サジェストを計算してメモリにキャッシュ |
| 旅行グループ確定/削除時 | 重複チェックのためサジェストを再計算 |
| イベント一覧表示時 | キャッシュ済みの結果を使用 |

サジェストは DB に保存しない（揮発的）。確定時に初めて永続化する。

---

## イベント一覧での表示

### 確定済み旅行グループ

```
┌─ ✈ 沖縄旅行  8/10〜8/14（5日間・53枚）── [アルバムにする] ─┐
│┃                                                          │
│┃  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐    │
│┃  │ 8/10     │ │ 8/11     │ │ 8/13     │ │ 8/14     │    │
│┃  │ 32枚     │ │ 15枚     │ │ 4枚      │ │ 2枚      │    │
│┃  └──────────┘ └──────────┘ └──────────┘ └──────────┘    │
│┃                                                          │
└────────────────────────────────────────────────────────────┘
```

- 背景色（薄い青）＋ 左サイドバー（3px 実線）
- 旅行ヘッダー: アイコン + タイトル + 期間 + 枚数 + アルバムボタン
- 中のイベントカードは既存のまま

### サジェスト（未確定）

```
┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─┐
╎  💡 旅行ですか？ 8/10〜8/14     [はい] [いいえ] [調整]   ╎
╎                                                          ╎
╎  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐    ╎
╎  │ 8/10     │ │ 8/11     │ │ 8/13     │ │ 8/14     │    ╎
╎  │ 32枚     │ │ 15枚     │ │ 4枚      │ │ 2枚      │    ╎
╎  └──────────┘ └──────────┘ └──────────┘ └──────────┘    ╎
╎                                                          ╎
└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─┘
```

- 点線の枠 + 薄いハイライト（確定済みより控えめ）
- 3つのアクション:
  - **はい**: そのまま確定。タイトルは自動生成（後から編集可）
  - **いいえ**: サジェストを非表示にする（dismissedとしてメモリに記録、次回スキャンまで維持）
  - **調整**: 範囲選択モードに入り、始点・終点を変更してから確定

### サジェストの非侵襲性

- サジェストはあくまで控えめな提案。見た目を邪魔しないよう点線＋薄色にとどめる
- スクロール位置や既存カードのレイアウトに影響しない
- サジェストが多すぎる場合は最新の5件のみ表示し、残りは折りたたみ

---

## 手動で旅行を作成（範囲選択）

サジェストがなくても、ユーザーが任意のイベントから旅行を作成できる。

### 起動方法

1. イベントカードを右クリック → コンテキストメニュー「旅行にまとめる」
2. または、イベント一覧のツールバーに「＋ 旅行を作成」ボタン

### 範囲選択フロー

```
Step 1: 始点選択
  ┌──────────────────────────────────────────────────────────┐
  │ 📌 旅行の最初の日を選んでください         [キャンセル]  │
  └──────────────────────────────────────────────────────────┘

  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
  │ 8/10 ◉  │ │ 8/11     │ │ 8/13     │ │ 8/14     │
  │ 32枚     │ │ 15枚     │ │ 4枚      │ │ 2枚      │
  └──────────┘ └──────────┘ └──────────┘ └──────────┘

  ※ 右クリックから起動した場合は、そのカードが始点として選択済み

Step 2: 終点選択
  ┌──────────────────────────────────────────────────────────┐
  │ 📌 旅行の最後の日を選んでください         [キャンセル]  │
  └──────────────────────────────────────────────────────────┘

  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
  │ 8/10 ✔  │ │ 8/11     │ │ 8/13     │ │ 8/14 ◉  │
  │ 始点     │ │ ██████░░ │ │ ██████░░ │ │ 32枚     │
  └──────────┘ └──────────┘ └──────────┘ └──────────┘

  ※ 始点〜ホバー位置のカードをハイライト表示（リアルタイムプレビュー）
  ※ 始点より前の日付は選択不可（グレーアウト）

Step 3: 確定
  ┌──────────────────────────────────────────────────────────┐
  │ ✈ 8/10〜8/14（5日間・53枚） タイトル: [        ]       │
  │                                     [作成] [キャンセル] │
  └──────────────────────────────────────────────────────────┘

  ※ タイトルは自動生成値がプリセット、空でも作成可（「旅行 (8/10〜8/14)」にフォールバック）
```

### 操作の制約

- 既に確定済みの旅行グループに含まれるイベント日は選択できない（重複防止）
- 始点と終点が同じ日でも作成可能（1日旅行 = 日帰り遠出）
- 範囲内に写真ゼロの日があっても問題ない（含まれるイベント日だけが対象）

---

## 旅行グループの編集・削除

確定済み旅行グループに対する操作。

### 旅行ヘッダーからの操作

| 操作 | UI | 動作 |
|---|---|---|
| タイトル編集 | ヘッダーのタイトルをクリック | インライン編集モードに切り替え |
| 範囲変更 | ヘッダー右端のメニュー → 「範囲を変更」 | 範囲選択モードに入る（始点・終点を再指定） |
| 解除 | ヘッダー右端のメニュー → 「旅行を解除」 | グループを解除、イベントカードは通常表示に戻る |
| アルバム作成 | 「アルバムにする」ボタン | 旅行アルバム作成ウィザードへ（spec-album.md 参照） |

---

## 旅行タイトルの自動生成

旅行期間内の写真タグから、旅行名を推定する。

```
1. 旅行期間内の全写真のタグを取得
2. 汎用タグを除外: 人物, 屋外, 屋内, 食事, テーブル, 椅子, 車
3. 残ったタグを出現回数で降順ソート
4. 上位1〜2個を取得
5. タイトル生成:
   - タグ2つ: 「{タグ1}・{タグ2}の旅」
   - タグ1つ: 「{タグ1}の旅」
   - タグなし: 「旅行 (M/D〜M/D)」
```

例: 「海」タグ 15回、「夕焼け」タグ 8回 → 「海・夕焼けの旅」

---

## データベース設計

旅行グループは確定時に DB に永続化する。サジェストは保存しない。

```sql
CREATE TABLE travel_groups (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    start_date TEXT NOT NULL,              -- 'YYYY-MM-DD'
    end_date TEXT NOT NULL,                -- 'YYYY-MM-DD'
    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);

-- 旅行期間の重複を防ぐためのインデックス
CREATE INDEX idx_travel_groups_dates ON travel_groups(start_date, end_date);
```

**シンプルに `start_date` / `end_date` の範囲だけ保持する。**
旅行に含まれるイベント日は `photos` テーブルから動的に取得する（範囲内の `taken_at` を検索）。

```sql
-- 旅行グループに含まれるイベント日を取得
SELECT DATE(taken_at) as event_date, COUNT(*) as photo_count
FROM photos
WHERE DATE(taken_at) BETWEEN ? AND ?
GROUP BY DATE(taken_at)
ORDER BY event_date;
```

### 重複チェック

旅行グループの範囲が重複してはならない。

```sql
-- 新しい旅行 (new_start, new_end) が既存と重複するか
SELECT COUNT(*) FROM travel_groups
WHERE start_date <= ? AND end_date >= ?;
-- パラメータ: (new_end, new_start)
-- 結果が 0 なら重複なし
```

---

## アルバム仕様書への影響

旅行検出の改訂に伴い、`spec-album.md` の旅行アルバム部分を以下のように読み替える。

| 旧（自動検出ベース） | 新（手動確定ベース） |
|---|---|
| 旅行検出結果から自動でアルバム候補を提示 | 確定済み旅行グループの「アルバムにする」ボタンから作成 |
| `album_date_ranges` テーブルに日付範囲を保存 | `albums.travel_group_id` で `travel_groups` を参照 |
| 旅行検出パラメータ変更でアルバム対象が変わる可能性 | 旅行グループは確定済みなので安定 |

`albums` テーブルへの追加カラム:

```sql
ALTER TABLE albums ADD COLUMN travel_group_id INTEGER REFERENCES travel_groups(id) ON DELETE SET NULL;
```

`album_date_ranges` テーブルは不要になる（`travel_groups` テーブルが代替）。

---

## react-virtuoso との統合

イベント一覧のアイテムリストに、旅行ヘッダー/フッターをダミーアイテムとして挿入する。

```typescript
type EventListItem =
    | { type: 'event'; date: string; photoCount: number; travelGroupId?: number }
    | { type: 'travel-header'; group: TravelGroupConfirmed | TravelGroupSuggestion }
    | { type: 'travel-footer' }
    | { type: 'range-select-bar' };  // 範囲選択モード時のインジケーター

interface TravelGroupConfirmed {
    status: 'confirmed';
    id: number;
    title: string;
    startDate: string;
    endDate: string;
    totalPhotos: number;
    albumId?: number;      // アルバム作成済みの場合
}

interface TravelGroupSuggestion {
    status: 'suggested';
    startDate: string;
    endDate: string;
    totalPhotos: number;
}
```

### 年月セクションとの関係

- 旅行グループは月境界で分断しない
- 旅行の開始月のセクションにまとめて表示
- 旅行に含まれる他月の日は、その月のセクションには重複表示しない

---

## 実装順序

1. **`travel_groups` テーブル作成** + CRUD 関数
2. **手動範囲選択UI**: 始点→終点→確定のフロー
3. **イベント一覧に確定済みグループを表示**: 背景色 + ヘッダー
4. **自動サジェスト**: 固定パラメータで検出 + 点線表示 + はい/いいえ/調整
5. **タイトル自動生成**: タグ集計ロジック
6. **アルバム連携**: `albums.travel_group_id` カラム追加 + ウィザード導線