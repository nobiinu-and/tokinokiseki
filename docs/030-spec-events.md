# できごと機能 仕様書

## 概要

タイムライン上で連続する日付を「できごと」としてグルーピングする機能。
旅行、イベント、制作期間など、複数日にまたがるあらゆる活動をまとめられる。
軽い自動サジェストで候補を提示し、ユーザーが確認・手動指定して確定する。
確定したできごとはアルバム作成の起点にもなる。

### 設計方針

- **ユーザー主導**: できごとかどうかを決めるのはユーザー。自動検出はあくまでサジェスト
- **シンプル**: 閾値設定画面は設けない。サジェストの精度より、手動操作の手軽さを重視
- **汎用的**: 旅行に限らず、あらゆる「まとめたい期間」に使える

---

## 用語対照表

この仕様書で導入する用語変更の一覧。既存の仕様書・コードに波及する。

| 旧用語 | 新用語 | 意味 | 影響箇所 |
|---|---|---|---|
| イベント一覧 | **タイムライン** | 日付順に写真カードが並ぶメイン画面 | 画面名、ルート名、ナビゲーション |
| イベント（1日単位） | **日付カード** | 写真がある1日分の表示単位 | コンポーネント名、変数名 |
| イベント詳細 | **日付詳細** | 特定日付の写真グリッド画面 | 画面名、ルート名 |
| 旅行グループ | **できごと** | 複数日をまとめたグルーピング | 新規概念（本仕様で定義） |

### ルーティング変更

| 旧ルート | 新ルート | 画面 |
|---|---|---|
| `/events` | `/timeline` | タイムライン |
| `/events/:date` | `/timeline/:date` | 日付詳細 |
| `/slideshow/:date` | `/slideshow/:date` | スライドショー（変更なし） |
| — | `/albums` | アルバム一覧（新規） |
| — | `/albums/:id` | アルバム閲覧（新規） |

---

## できごとの状態

| 状態 | 意味 | 表示 |
|---|---|---|
| **サジェスト** | 自動検出した候補。まだユーザーが確認していない | 点線の枠 + 「できごとですか？」バッジ |
| **確定済み** | ユーザーが確定したできごと | 実線の枠 + できごとヘッダー |

---

## 自動サジェスト

### ロジック

固定パラメータで軽く検出する。ユーザー向け設定は不要。

```
パラメータ（固定）:
  minDays = 2           // 2日以上
  maxGap  = 1           // 1日の空白は許容
  minPhotosPerDay = 3   // 1〜2枚の日は日常として除外

入力: 写真がある日付のリスト（写真枚数付き）

1. 写真枚数 < minPhotosPerDay の日を除外
2. 残った日を昇順ソート
3. 隣接する日の間隔が maxGap 以下なら連結
4. 連結グループの暦日数（endDate - startDate + 1）が minDays 未満なら除外
5. 既に確定済みのできごとと重複するサジェストは除外

出力: サジェスト候補リスト
```

- パラメータは固定値。ユーザーに見せない
- 完璧な検出は目指さない。漏れは手動で作ればよい
- 多少の誤検出は許容。確認ステップがあるので問題にならない

### 計算タイミング

| タイミング | 処理 |
|---|---|
| タイムライン表示時 | `getEventSuggestions` でサジェストを都度計算し表示 |
| できごと確定/削除時 | タイムラインをリフレッシュし、サジェストを再計算 |

サジェストは DB に保存しない（揮発的）。できごとの確定内容のみを永続化する。

---

## タイムラインでの表示

### 確定済みできごと

```
┌─ 🏷 沖縄旅行  8/10〜8/14（5日間・53枚）── [アルバムにする] ─┐
│┃                                                            │
│┃  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │
│┃  │ 8/10     │ │ 8/11     │ │ 8/13     │ │ 8/14     │      │
│┃  │ 32枚     │ │ 15枚     │ │ 4枚      │ │ 2枚      │      │
│┃  └──────────┘ └──────────┘ └──────────┘ └──────────┘      │
│┃                                                            │
└──────────────────────────────────────────────────────────────┘
```

- 背景色（薄い青）＋ 左サイドバー（3px 実線）
- できごとヘッダー: タイトル + 期間 + 枚数 + アルバムボタン
- 中の日付カードは既存のまま変更しない

### サジェスト（未確定）

```
┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─┐
╎  💡 できごとですか？ 8/10〜8/14   [はい] [いいえ] [調整]   ╎
╎                                                            ╎
╎  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      ╎
╎  │ 8/10     │ │ 8/11     │ │ 8/13     │ │ 8/14     │      ╎
╎  │ 32枚     │ │ 15枚     │ │ 4枚      │ │ 2枚      │      ╎
╎  └──────────┘ └──────────┘ └──────────┘ └──────────┘      ╎
╎                                                            ╎
└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─┘
```

- 点線の枠 + 薄いハイライト（確定済みより控えめ）
- 3つのアクション:
  - **はい**: そのまま確定。タイトル入力を促す（空なら自動生成）
  - **いいえ**: サジェストを非表示にする（dismissedとしてメモリに記録、次回スキャンまで維持）
  - **調整**: 範囲選択モードに入り、始点・終点を変更してから確定

### サジェストの非侵襲性

- サジェストはあくまで控えめな提案。見た目を邪魔しないよう点線＋薄色にとどめる
- スクロール位置や既存カードのレイアウトに影響しない
- サジェストが多すぎる場合は最新の5件のみ表示し、残りは折りたたみ

---

## 手動でできごとを作成（範囲選択）

サジェストがなくても、ユーザーが任意の日付カードからできごとを作成できる。

### 起動方法

1. 日付カードを右クリック → コンテキストメニュー「できごとにまとめる」
2. または、タイムラインのツールバーに「＋ できごとを作成」ボタン

### 範囲選択フロー

```
Step 1: 始点選択
  ┌──────────────────────────────────────────────────────────┐
  │ 📌 できごとの最初の日を選んでください      [キャンセル] │
  └──────────────────────────────────────────────────────────┘

  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
  │ 8/10 ◉  │ │ 8/11     │ │ 8/13     │ │ 8/14     │
  │ 32枚     │ │ 15枚     │ │ 4枚      │ │ 2枚      │
  └──────────┘ └──────────┘ └──────────┘ └──────────┘

  ※ 右クリックから起動した場合は、そのカードが始点として選択済み

Step 2: 終点選択
  ┌──────────────────────────────────────────────────────────┐
  │ 📌 できごとの最後の日を選んでください      [キャンセル] │
  └──────────────────────────────────────────────────────────┘

  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
  │ 8/10 ✔  │ │ 8/11     │ │ 8/13     │ │ 8/14 ◉  │
  │ 始点     │ │ ██████░░ │ │ ██████░░ │ │ 2枚      │
  └──────────┘ └──────────┘ └──────────┘ └──────────┘

  ※ 始点〜ホバー位置のカードをハイライト表示（リアルタイムプレビュー）
  ※ 始点より前の日付は選択不可（グレーアウト）

Step 3: 確定
  ┌──────────────────────────────────────────────────────────┐
  │ 🏷 8/10〜8/14（5日間・53枚） タイトル: [沖縄旅行    ]  │
  │                                     [作成] [キャンセル] │
  └──────────────────────────────────────────────────────────┘

  ※ タイトルは自動生成値がプリセット、空でも作成可（「できごと (8/10〜8/14)」にフォールバック）
```

### 操作の制約

- 既に確定済みのできごとに含まれる日付カードは選択できない（重複防止）
- 始点と終点が同じ日でも作成可能（1日のできごと = 日帰り遠出、単日イベントなど）
- 範囲内に写真ゼロの日があっても問題ない（写真がある日だけが日付カードとして表示される）

---

## できごとの編集・削除

確定済みできごとに対する操作。

### できごとヘッダーからの操作

| 操作 | UI | 動作 |
|---|---|---|
| タイトル編集 | ヘッダーのタイトルをクリック | インライン編集モードに切り替え |
| 範囲変更 | ヘッダー右端のメニュー → 「範囲を変更」 | 範囲選択モードに入る（始点・終点を再指定） |
| 解除 | ヘッダー右端のメニュー → 「できごとを解除」 | グループを解除、日付カードは通常表示に戻る |
| アルバム作成 | 「アルバムにする」ボタン | アルバム作成ウィザードへ（spec-album.md 参照） |

---

## できごとタイトルの自動生成

できごと期間内の写真タグからタイトルを推定する。

```
1. 期間内の全写真のタグを取得
2. 汎用タグを除外: 人物, 屋外, 屋内, 食事, テーブル, 椅子, 車
3. 残ったタグを出現回数で降順ソート
4. 上位1〜2個を取得
5. タイトル生成:
   - タグ2つ: 「{タグ1}・{タグ2}」  例: 「海・夕焼け」
   - タグ1つ: 「{タグ1}」            例: 「プラモデル」
   - タグなし: 「できごと (M/D〜M/D)」
```

※ 旧仕様の「〜の旅」という接尾辞は削除。旅行とは限らないため。

---

## データベース設計

できごとは確定時に DB に永続化する。サジェストは保存しない。

```sql
CREATE TABLE events (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timeline_id INTEGER NOT NULL,
    title TEXT NOT NULL,
    type TEXT NOT NULL DEFAULT 'range',    -- 'range' | 'dates'
    start_date TEXT NOT NULL,              -- 'YYYY-MM-DD'
    end_date TEXT NOT NULL,                -- 'YYYY-MM-DD'
    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    updated_at TEXT NOT NULL DEFAULT (datetime('now')),
    FOREIGN KEY (timeline_id) REFERENCES timelines(id) ON DELETE CASCADE
);

CREATE TABLE event_dates (
    event_id INTEGER NOT NULL,
    date TEXT NOT NULL,                    -- 'YYYY-MM-DD'
    PRIMARY KEY (event_id, date),
    FOREIGN KEY (event_id) REFERENCES events(id) ON DELETE CASCADE
);
```

- **Range型**: `start_date`〜`end_date` の範囲で写真を動的に取得
- **Dates型**: `event_dates` に個別日付を保持。`start_date`/`end_date` は min/max から自動同期（クエリ効率のため）
- できごとの重複は許可（同じ日が複数のできごとに含まれてOK）

---

## 年月セクションとの関係

できごとが月をまたぐ場合のルール:

- できごとグループは月境界で分断しない
- できごとの開始月のセクションにまとめて表示
- できごとに含まれる日（翌月分）は、その月のセクションには重複表示しない

---

## react-virtuoso との統合

タイムラインのアイテムリストに、できごとヘッダー/フッターをダミーアイテムとして挿入する。

```typescript
type TimelineItem =
    | { type: 'date-card'; date: string; photoCount: number; eventId?: number }
    | { type: 'event-header'; event: EventConfirmed | EventSuggestion }
    | { type: 'event-footer' }
    | { type: 'range-select-bar' };  // 範囲選択モード時のインジケーター

interface EventConfirmed {
    status: 'confirmed';
    id: number;
    title: string;
    startDate: string;
    endDate: string;
    totalPhotos: number;
    albumId?: number;       // アルバム作成済みの場合
}

interface EventSuggestion {
    status: 'suggested';
    startDate: string;
    endDate: string;
    totalPhotos: number;
}
```

---

## アルバム仕様書への影響

用語変更に伴い、`spec-album.md` を以下のように読み替える。

| 旧 | 新 |
|---|---|
| 旅行アルバム | **できごとアルバム** |
| 旅行検出結果 | できごと（確定済み） |
| `album_date_ranges` テーブル | 不要（`albums.event_id` で `events` を参照） |
| `travel_group_id` | `event_id` |

`albums` テーブルへの追加カラム:

```sql
ALTER TABLE albums ADD COLUMN event_id INTEGER REFERENCES events(id) ON DELETE SET NULL;
```

---

## 実装順序

1. **用語リネーム**: 既存コードの `event` → `dateCard` / ルート `/events` → `/timeline` など
2. **`events` テーブル作成** + CRUD 関数
3. **手動範囲選択UI**: 始点→終点→タイトル→確定のフロー
4. **タイムラインに確定済みできごとを表示**: 背景色 + ヘッダー
5. **自動サジェスト**: 固定パラメータで検出 + 点線表示 + はい/いいえ/調整
6. **タイトル自動生成**: タグ集計ロジック
7. **アルバム連携**: `albums.event_id` カラム追加 + ウィザード導線